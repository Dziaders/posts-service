# Posts Service

This is a NestJS-based microservice for managing posts. It supports basic CRUD operations and is intended to be part of a larger platform.

## Features
- Create, Read, Update, Delete operations on `Post` entities.
- Automatic validation of inputs.
- Hash generation (MD5) based on the post's title and content.
- Event emission on each CRUD action.
- Comprehensive error handling with defined JSON error responses.
- Integration with a database and Docker-based deployment.
- Unit and E2E tests.

## Getting Started

### Prerequisites
- Node.js (16+)
- npm (or yarn)
- Docker and Docker Compose

### Running Locally
```bash
npm install
npm run start:dev
```

## Database and Migrations

This service uses PostgreSQL and TypeORM for the database.

### Running with Docker
```bash
docker compose up --build
```

## Entity: Post

The `Post` entity has the following fields:
- `id` (UUID): Primary key, generated by the database.
- `title` (string, 3-100 chars, unique): Required.
- `content` (string, min. 3 chars): Required.
- `state` (enum: DRAFT|PUBLISHED): Optional, defaults to DRAFT.
- `hash` (string, 32 chars): Generated by the application based on title+content.
- `created_at`/`updated_at` (datetime): Managed by the application/database.

Migrations have been set up so that the `posts` table is created automatically.

### Hash Generation & State Defaults
- If `state` is not provided when creating a post, it defaults to `DRAFT`.
- `hash` is automatically generated (MD5) from `title + content` during creation and every update.
- `created_at` and `updated_at` timestamps are managed automatically by the database (via TypeORM decorators).

## CRUD operations:

    GET /posts → findAll()
    POST /posts → create()
    GET /posts/:id → findOne()
    PUT /posts/:id → update()
    DELETE /posts/:id → remove()

### Postman request example
    Method: POST
    URL: http://localhost:3000/posts
    Headers: Content-Type: application/json
    Body (raw, JSON):
      {
        "title": "My First Post",
        "content": "This is the content of my first post.",
        "state": "DRAFT"
      }


## Kafka Integration

This service can emit events via Kafka. By default, `EVENTS_PROVIDER=console`, which just logs events to the console. To use Kafka:

1. Ensure `docker-compose.yml` has the `zookeeper` and `kafka` services defined.
2. Set `EVENTS_PROVIDER=kafka` in your `.env` file and in `docker-compose.yml` environment section of `posts-service`.

To see kafka in action you can listen to the incoming events by running:
```bash
docker exec -it kafka bash
kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic posts_events --from-beginning
```
   
## Error Handling

All errors are handled by a global exception filter, which ensures the response follows the format:
```json
{
  "message": "Entity not found",
  "status": 404,
  "service": "posts"
}
```

## Troubleshooting
<span style="color:red"> posts-db [116] ERROR:  relation "posts" does not exist </span>

   This message in the console means the database on doker image started without running the migrations. To fix the problem: make sure the doker image is running, then in the second terminal run:
```
docker compose exec posts-service npm run migration:run
```

